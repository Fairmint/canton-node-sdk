# Canton Node SDK (`@fairmint/canton-node-sdk`)

> Low-level TypeScript SDK for interacting with Canton blockchain nodes.

## Living Document

**This file is a living document.** Update it automatically when:
- A best practice or pattern is established during AI conversations
- An important architectural or coding decision is made
- The user communicates a preference that applies beyond the current task
- **Creating a PR**: Before creating a PR, review the completed task for any generalizable learnings or best practices that should be added to this file. This ensures AI improves with every task.

Keep content concise but comprehensive. Avoid verbosity—capture the essence.

## PR Workflow (REQUIRED)

### Before Commit & Push

**Always run lint/format before committing:**

```bash
npm run fix    # Auto-fix lint + formatting issues (if available)
npm run lint   # Verify no lint errors
```

### After Creating a PR

1. **Open the PR to the files/changes page:**
   ```bash
   open <PR_URL>/files    # Review your changes
   ```

2. **Monitor CI status** and automatically investigate/fix any failures:
   ```bash
   gh pr checks <PR_NUMBER>              # Check all CI checks
   gh run view <RUN_ID> --log-failed     # View failed job logs
   gh run view --job=<JOB_ID>            # View specific job details
   ```

3. **If CI fails:** Investigate the failure, fix the issue, and push the fix. Repeat until CI passes.

### Git Workflow

**Avoid force pushing** (`git push --force`). To update a PR branch:

```bash
git fetch origin main
git merge origin/main
# Resolve conflicts if any
git push
```

This preserves commit history and makes PR review easier.

## Dependencies

When adding dependencies, always use **pinned versions** (no `^` or `~` prefixes). This ensures reproducible builds.

```bash
npm install package@1.2.3 --save-exact    # For dependencies
npm install package@1.2.3 --save-dev --save-exact  # For devDependencies
```

**Why:** Pre-1.0 packages (like `0.x.y`) may introduce breaking changes in minor versions. Pinned versions ensure reproducible builds and prevent unexpected breakage.

## Quick Commands

```bash
npm run lint && npm run build && npm test   # After any change
npm run build:core                          # Generate + compile only
npm run test:watch                          # Dev mode
```

## Architecture

### Client Hierarchy

```
BaseClient (OAuth2 auth)         SimpleBaseClient (no auth)
     │                                   │
     ├── LedgerJsonApiClient            └── LighthouseClient
     ├── ValidatorApiClient
     └── ScanApiClient
```

### Operation Pattern

Use factory functions for most operations:

```typescript
// REST operations - use createApiOperation
export const GetVersion = createApiOperation<void, GetVersionResponse>({
  paramsSchema: z.void(),
  method: 'GET',
  buildUrl: (_params, apiUrl) => `${apiUrl}/v2/version`,
});

// WebSocket operations - use createWebSocketOperation
export const SubscribeToCompletions = createWebSocketOperation<Params, Request, Message>({
  paramsSchema: CompletionStreamRequestSchema,
  buildPath: (_params, _apiUrl) => '/v2/commands/completions',
  buildRequestMessage: (params, client) => ({ /* ... */ }),
});
```

Use classes for complex operations needing async pre-processing or state management:

```typescript
// Class pattern for operations with async defaults
export class GetMemberTrafficStatus extends ApiOperation<Params, Response> {
  async execute(params: Params): Promise<Response> {
    const domainId = params.domainId ?? await getCurrentMiningRoundDomainId(this.client);
    // ...
  }
}
```

See [CONTRIBUTING.md](CONTRIBUTING.md) for detailed pattern guidelines.

### Configuration

Environment variables follow: `CANTON_{NETWORK}_{PROVIDER}_{SETTING}`

```
CANTON_DEVNET_5N_LEDGER_JSON_API_URI=https://...
CANTON_DEVNET_5N_LEDGER_JSON_API_CLIENT_ID=...
CANTON_DEVNET_5N_LEDGER_JSON_API_CLIENT_SECRET=...
```

Use `EnvLoader.getConfig()` to load programmatically.

## File Structure

```
src/
├── clients/
│   ├── register.ts           # All client exports
│   ├── ledger-json-api/      # Ledger JSON API client
│   │   ├── LedgerJsonApiClient.ts
│   │   ├── operations/       # One class per endpoint
│   │   └── schemas/          # Zod schemas, generated types
│   ├── validator-api/        # Validator API client
│   └── scan-api/             # Scan API client
├── utils/                    # Utility functions (createParty, etc.)
├── auth/                     # AuthenticationManager (OAuth2)
└── errors/                   # Custom error classes
```

## Adding a New API Client

1. Add OpenAPI spec to `specs/`
2. Run `npm run generate:openapi`
3. Create client class extending `BaseClient` or `SimpleBaseClient`
4. Implement operations in `operations/`
5. Export from `src/clients/register.ts`

## Adding a New Operation

1. Create class in `src/clients/{api}/operations/`
2. Extend `ApiOperation` or `SimpleApiOperation`
3. Define `path`, `method`, request/response schemas
4. Add to client class and export

## Error Hierarchy

```typescript
CantonError                 // Base
├── ConfigurationError      // Missing/invalid config
├── AuthenticationError     // OAuth2 failures
├── ApiError               // HTTP errors
├── ValidationError        // Schema validation
└── NetworkError           // Connection issues
```

## External Signing

For user-controlled private keys (wallets):

1. Generate keypair (`@stellar/stellar-base`)
2. `createExternalParty()` - Onboard party
3. `prepareExternalTransaction()` - Get hash to sign
4. Sign with private key
5. `executeExternalTransaction()` - Submit

See [docs/EXTERNAL_SIGNING.md](docs/EXTERNAL_SIGNING.md) for details.

## TypeScript Strictness

- `noImplicitAny`, `noImplicitReturns`, `exactOptionalPropertyTypes`
- Always provide explicit return types
- Never use `any`

## Testing

- Unit tests in `test/unit/`
- Integration tests require LocalNet (see below)
- Run specific test: `npm test path/to/test.spec.ts`

## LocalNet (cn-quickstart)

The SDK includes cn-quickstart as a git submodule for local development and testing against a real Canton Network.

### Location

```
libs/cn-quickstart/quickstart/   # cn-quickstart directory
```

### Prerequisites

- **Docker Desktop** running with at least 8GB RAM allocated
- **DAML SDK** (installed via `make install-daml-sdk`)

### First-Time Setup

```bash
# Initialize submodule (if not already done)
git submodule update --init --recursive

# Navigate to cn-quickstart
cd libs/cn-quickstart/quickstart

# Run interactive setup (creates .env.local)
make setup
# Choose: OAuth2 mode or shared-secret mode
# Set party hint (e.g., "quickstart-dev-1")

# Install DAML SDK (if not already installed)
make install-daml-sdk
```

### Starting LocalNet

```bash
cd libs/cn-quickstart/quickstart
make start   # Builds and starts all containers (~4-5 min first time)
```

Wait for all services to become healthy:

```bash
docker ps --format "table {{.Names}}\t{{.Status}}"
# All services should show "healthy" before running tests
```

### Stopping LocalNet

```bash
cd libs/cn-quickstart/quickstart
make stop              # Stop all containers
make clean-all-docker  # Full reset (removes all containers/volumes)
```

### LocalNet Services and Ports

| Service | Port | Description |
|---------|------|-------------|
| App-Provider JSON API | 3975 | Ledger API for app_provider participant |
| App-Provider Validator | 3903 | Validator API for app_provider |
| App-User JSON API | 2975 | Ledger API for app_user participant |
| SV JSON API | 4975 | Ledger API for super validator |
| Keycloak | 8082 | OAuth2 authentication |
| Scan API | scan.localhost:4000 | Network-wide contract queries |
| Swagger UI | 9090 | API documentation |
| Grafana | 3030 | Observability dashboard |

### OAuth2 Credentials (app-provider)

Default LocalNet OAuth2 credentials:

```
Auth URL: http://localhost:8082/realms/AppProvider/protocol/openid-connect/token
Client ID: app-provider-validator
Client Secret: AL8648b9SfdTFImq7FV56Vd0KHifHBuC
```

### Troubleshooting

#### "Cannot connect to Docker daemon"
```bash
# Start Docker Desktop, then verify
docker ps
```

#### "HTTP 503" or "Connection refused"
Services aren't ready yet. Wait for all containers to show "healthy":
```bash
docker ps --format "table {{.Names}}\t{{.Status}}" | grep -v healthy
# Should return nothing when ready
```

#### "Container keeps restarting"
Reset everything:
```bash
cd libs/cn-quickstart/quickstart
make clean-all-docker  # Remove all containers and volumes
make start
```

#### "Port already in use"
```bash
make stop              # Stop LocalNet containers
lsof -i :3975          # Find what's using JSON API port
```

### Useful Make Targets

```bash
make status            # Show container status
make logs              # View all logs
make tail              # Tail logs in real-time
make restart           # Stop and start
make canton-console    # Interactive Canton console
```

### Known Limitations

1. **First-time startup**: Takes longer as it builds images and compiles DAML code
2. **Resource usage**: Runs ~20+ containers, requires 8GB+ RAM for Docker
3. **State persistence**: Canton restarts clear all ledger state (DARs, contracts)

## NPM Publishing

The package `@fairmint/canton-node-sdk` is automatically published to NPM when changes are merged to `main`.

### How It Works

1. **Create a PR** with your changes
2. **Monitor CI status** (see below)
3. **Open the PR** in browser for review: `open <PR_URL>`
4. **Get it reviewed** and approved
5. **Merge to main** - CI automatically:
   - Builds the package
   - Increments the patch version in `package.json`
   - Generates a changelog from commits since last release
   - Publishes to NPM
   - Creates and pushes a git tag (e.g., `v0.0.128`)
   - Deploys documentation to GitHub Pages

### Version Bumping

- **Patch bumps** (0.0.127 → 0.0.128): Automatic on every merge to main
- **Minor/Major bumps**: Manually update `package.json` version before merging

### Manual Release (Local)

```bash
npm run prepare-release   # Bumps version, generates changelog
npm publish               # Publishes to NPM (requires NPM_TOKEN)
```

### CI Requirements

The publish workflow requires:
- `NPM_TOKEN` secret configured in GitHub repository settings

### Monitoring PR CI Status

See "PR Workflow" section above for CI monitoring instructions.

## Related Repos

| Repo | Purpose | Docs |
|------|---------|------|
| `canton` | Trading infrastructure, ADRs | `llms.txt` |
| `canton-explorer` | Next.js explorer UI | `llms.txt`, [cantonops.fairmint.com](https://cantonops.fairmint.com/) |
| `canton-fairmint-sdk` | Shared TypeScript utilities | `llms.txt` |
| `ocp-canton-sdk` | High-level OCP TypeScript SDK | `llms.txt`, [ocp.canton.fairmint.com](https://ocp.canton.fairmint.com/) |
| `ocp-position-nft` | Soulbound NFT smart contracts | `llms.txt` |
| `open-captable-protocol-daml` | DAML contracts (OCF impl) | `llms.txt` |

## Docs

- End-user docs: [sdk.canton.fairmint.com](https://sdk.canton.fairmint.com/)
- API reference: `docs/` (Jekyll site)
- External signing: [docs/EXTERNAL_SIGNING.md](docs/EXTERNAL_SIGNING.md)
