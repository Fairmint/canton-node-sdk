# Canton Node SDK

> A TypeScript SDK for interacting with Canton blockchain nodes. Provides type-safe, OAuth2-authenticated clients for Ledger JSON API, Validator API, and other Canton services.

## ğŸ“– Human Documentation (Read These First)

- **[README.md](README.md)** - Project overview, quick start, and user-facing documentation
- **[DEVELOPER_GUIDE.md](DEVELOPER_GUIDE.md)** - Comprehensive development guide with setup, workflows, and best practices

**Important**: All human-focused documentation lives in these files. This file (`llms.txt`) provides AI-specific context and patterns. When in doubt, refer to the human documentation.

## Key Technical Details

- **Language**: TypeScript 5.9.3
- **Runtime**: Node.js >= 18.0.0
- **Package Manager**: npm
- **Build Tool**: TypeScript Compiler (tsc)
- **Testing**: Jest 30.2.0
- **Linting**: ESLint 9.38.0 + Prettier 3.6.2
- **Authentication**: OAuth2 (client_credentials and password grants)
- **HTTP Client**: axios 1.12.2
- **Type Generation**: openapi-typescript 7.10.1
- **Validation**: zod 4.1.12

## Architecture Patterns

### Client Architecture

- **Base Classes**: `BaseClient` (OAuth2) and `SimpleBaseClient` (no auth)
- **Client Instantiation**: Direct instantiation with optional config
  ```typescript
  const client = new LedgerJsonApiClient(config);
  // Or use EnvLoader defaults:
  const client = new LedgerJsonApiClient();
  ```
- **Client Registration**: All clients exported from `src/clients/register.ts`
- **Type Safety**: Full TypeScript types generated from OpenAPI specs

### Operation Pattern

- **Base Classes**: `ApiOperation<Params, Response>` and `SimpleApiOperation<Params, Response>`
- **Structure**: Each API endpoint is a class extending the operation base
- **Organization**: Operations in `src/clients/{api-name}/operations/`
- **Validation**: Zod schemas for request/response validation
- **Execution**: `execute(params)` method handles the full request flow

### Configuration Management

- **Pattern**: `CANTON_{NETWORK}_{PROVIDER}_{SETTING}`
- **Example**: `CANTON_TESTNET_BNS_LEDGER_API_URL`
- **Networks**: `devnet`, `testnet`, `mainnet`, `localnet`
- **Providers**: Varies by network (e.g., `5n`, `bns`, `app-provider`)
- **Singleton**: `EnvLoader` manages all environment variables
- **Auto-detection**: Clients can use EnvLoader defaults or explicit config

### Authentication

- **Manager**: `AuthenticationManager` handles OAuth2 token lifecycle
- **Grant Types**: `client_credentials` (machine-to-machine) and `password` (user)
- **Auto-refresh**: Tokens automatically refreshed before expiration
- **Bearer Injection**: Tokens automatically added to request headers

### Code Generation

- **OpenAPI Specs**: Located in `libs/splice/**/openapi/**/*.yaml`
- **Type Generation**: `npm run generate:openapi-types` creates TypeScript types
- **Client Methods**: `npm run build:core:generate-client-methods` generates client wrappers
- **Generated Files**: `src/clients/*/generated/` (git-ignored, generated on build)

### Error Handling

Custom error hierarchy (all extend `CantonError`):

- `ConfigurationError` - Missing/invalid environment configuration
- `AuthenticationError` - OAuth2 authentication failures
- `ApiError` - HTTP API request failures (includes status code, response body)
- `ValidationError` - Zod schema validation failures
- `NetworkError` - Network connectivity issues

## File Structure Overview

```
src/
â”œâ”€â”€ clients/                    # API client implementations
â”‚   â”œâ”€â”€ register.ts            # Client exports
â”‚   â”œâ”€â”€ ledger-json-api/       # Ledger JSON API client
â”‚   â”‚   â”œâ”€â”€ operations/        # API endpoint operations
â”‚   â”‚   â””â”€â”€ schemas/           # Request/response schemas
â”‚   â””â”€â”€ validator-api/         # Validator API client
â”‚       â””â”€â”€ operations/        # API endpoint operations
â”œâ”€â”€ core/                      # Core SDK functionality
â”‚   â”œâ”€â”€ BaseClient.ts         # Base client with OAuth2
â”‚   â”œâ”€â”€ SimpleBaseClient.ts   # Base client without auth
â”‚   â”œâ”€â”€ auth/                 # Authentication manager
â”‚   â”œâ”€â”€ config/               # Environment loader
â”‚   â”œâ”€â”€ errors.ts             # Error classes
â”‚   â”œâ”€â”€ http/                 # HTTP client wrapper
â”‚   â”œâ”€â”€ operations/           # Operation base classes
â”‚   â””â”€â”€ ws/                   # WebSocket client
â””â”€â”€ utils/                     # Utility functions
    â”œâ”€â”€ amulet/               # Amulet (token) utilities
    â”œâ”€â”€ contracts/            # Contract utilities
    â”œâ”€â”€ external-signing/     # External party management
    â”œâ”€â”€ mining/               # Mining utilities
    â”œâ”€â”€ parsers/              # Data parsers
    â””â”€â”€ party/                # Party management

test/
â”œâ”€â”€ unit/                     # Unit tests
â””â”€â”€ integration/             # Integration tests

scripts/                      # Build and generation scripts
â”œâ”€â”€ generate-openapi-types.ts
â”œâ”€â”€ generate-all-client-methods.ts
â””â”€â”€ generate-operation-docs.ts
```

## ADR Quick Reference

| ADR | Decision | What This Means for Development |
|-----|----------|--------------------------------|
| (None yet) | - | ADRs will be added as architectural decisions are made |

## Code Patterns (Do / Don't)

### âœ… DO: Use EnvLoader for Configuration

```typescript
// âœ… DO: Let EnvLoader handle defaults
const client = new LedgerJsonApiClient();

// âœ… DO: Explicit config when needed
const client = new LedgerJsonApiClient({
  network: 'testnet',
  provider: '5n',
  apis: {
    ledgerJsonApi: {
      uri: 'https://custom-url.com',
      clientId: '...',
      clientSecret: '...',
    },
  },
});
```

### âŒ DON'T: Access process.env Directly

```typescript
// âŒ DON'T: Direct environment access
const apiUrl = process.env.CANTON_TESTNET_5N_LEDGER_API_URL;

// âœ… DO: Use EnvLoader
const config = EnvLoader.getConfig('ledgerJsonApi');
const apiUrl = config.apis.ledgerJsonApi.uri;
```

### âœ… DO: Extend Operation Base Classes

```typescript
// âœ… DO: Extend ApiOperation for authenticated endpoints
export class GetUserOperation extends ApiOperation<GetUserParams, User> {
  async execute(params: GetUserParams): Promise<User> {
    return this.makeGetRequest(`/v2/users/${params.userId}`);
  }
}
```

### âŒ DON'T: Create Operations Without Base Classes

```typescript
// âŒ DON'T: Standalone operation classes
export class GetUserOperation {
  // Missing validation, error handling, auth injection
}
```

### âœ… DO: Use Zod for Validation

```typescript
// âœ… DO: Validate with Zod schemas
const paramsSchema = z.object({
  userId: z.string().min(1),
});

export class GetUserOperation extends ApiOperation<GetUserParams, User> {
  async execute(params: GetUserParams): Promise<User> {
    const validated = this.validateParams(params, paramsSchema);
    return this.makeGetRequest(`/v2/users/${validated.userId}`);
  }
}
```

### âœ… DO: Use Generated Types from OpenAPI

```typescript
// âœ… DO: Import types from generated OpenAPI types
import type { paths } from '../../../generated/canton/.../openapi';

type GetUserResponse = paths['/v2/users/{userId}']['get']['responses']['200']['content']['application/json'];
```

### âŒ DON'T: Manually Define Types That Exist in OpenAPI

```typescript
// âŒ DON'T: Redefine types that OpenAPI already provides
interface User {
  id: string;
  // ... manually defined
}
```

### âœ… DO: Throw Appropriate Error Types

```typescript
// âœ… DO: Use specific error types
if (!config.apis?.ledgerJsonApi?.uri) {
  throw new ConfigurationError('Missing LEDGER_API_URL');
}

if (response.status === 401) {
  throw new AuthenticationError('Invalid credentials');
}
```

### âŒ DON'T: Use Generic Errors

```typescript
// âŒ DON'T: Generic errors
throw new Error('Something went wrong');
```

### âœ… DO: Provide Explicit Return Types

```typescript
// âœ… DO: Always specify return types
export async function getUser(userId: string): Promise<User> {
  // ...
}
```

### âŒ DON'T: Rely on Type Inference for Public APIs

```typescript
// âŒ DON'T: Let TypeScript infer return types for public methods
export async function getUser(userId: string) {
  // Return type should be explicit
}
```

## API Endpoints

### Ledger JSON API

| Method | Path | Purpose |
|--------|------|---------|
| GET | `/v2/version` | Get API version |
| GET | `/v2/users/{userId}` | Get user details |
| POST | `/v2/users` | Create user |
| GET | `/v2/parties` | List parties |
| POST | `/v2/commands/submit` | Submit command |
| GET | `/v2/updates` | Subscribe to updates |

### Validator API

| Method | Path | Purpose |
|--------|------|---------|
| POST | `/v0/register` | Register external party |
| GET | `/v0/scan-proxy/...` | Various scan proxy endpoints |

See `docs/ledger-json-api-operations.md` and `docs/validator-api-operations.md` for complete API reference.

## Development Workflow

**See [DEVELOPER_GUIDE.md](DEVELOPER_GUIDE.md) for complete workflow details.**

Quick reference:
- Build: `npm run build` (full) or `npm run build:core` (core only)
- Test: `npm test` or `npm run test:watch`
- Lint: `npm run lint` or `npm run lint:fix`
- After changes: `npm run lint && npm run build && npm test`

## Common Development Tasks

**See [DEVELOPER_GUIDE.md](DEVELOPER_GUIDE.md) for detailed task instructions.**

Quick reference:
- Adding API clients: See "Common Development Tasks" in DEVELOPER_GUIDE.md
- Adding operations: See "Common Development Tasks" in DEVELOPER_GUIDE.md
- Environment setup: See "Development Environment Setup" in DEVELOPER_GUIDE.md
- Testing: See "Testing" section in DEVELOPER_GUIDE.md

## Documentation Links

- [README.md](README.md) - Project overview and quick start
- [DEVELOPER_GUIDE.md](DEVELOPER_GUIDE.md) - Comprehensive development guide
- [CONTRIBUTING.md](CONTRIBUTING.md) - Publishing and contribution guidelines
- [docs/EXTERNAL_SIGNING.md](docs/EXTERNAL_SIGNING.md) - External party management
- [API Documentation](https://sdk.canton.fairmint.com/) - Full API reference
