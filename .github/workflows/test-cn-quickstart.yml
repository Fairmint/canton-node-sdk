name: Test CN-Quickstart Integration

on:
  push:
    branches: [main, master]
  pull_request:
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  test-cn-quickstart:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Compute Submodule Cache Key
        id: submodule-cache-key
        run: |
          set -euo pipefail
          # Works even when submodules are not initialized: uses gitlinks recorded in this repo.
          key="$(git submodule status --recursive | tr -s ' ' | cut -d' ' -f1-2 | sha256sum | cut -d' ' -f1)"
          echo "value=$key" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Initialize Submodules
        run: |
          # If a previous run/cached state left an incomplete submodule checkout around,
          # `git submodule update` can fail with "could not get a repository handle".
          rm -rf libs/splice
          rm -rf libs/cn-quickstart
          git submodule update --init --depth 1 libs/splice
          git submodule update --init --recursive libs/cn-quickstart

      - name: Restore Quickstart Preparation Cache
        id: quickstart-prep-cache-restore
        uses: actions/cache/restore@v4
        with:
          path: |
            ${{ github.workspace }}/node_modules
            ${{ github.workspace }}/artifacts
            ${{ github.workspace }}/build
            ${{ github.workspace }}/libs/cn-quickstart/quickstart/.env.local
            ${{ github.workspace }}/libs/cn-quickstart/quickstart/.gradle
            ${{ github.workspace }}/libs/cn-quickstart/quickstart/.daml
            ${{ github.workspace }}/libs/cn-quickstart/quickstart/.config
            ${{ github.workspace }}/libs/cn-quickstart/quickstart/.cache
            ${{ github.workspace }}/libs/cn-quickstart/quickstart/frontend/node_modules
            ${{ github.workspace }}/libs/cn-quickstart/quickstart/frontend/dist
            ${{ github.workspace }}/libs/cn-quickstart/quickstart/backend/build
            ${{ github.workspace }}/libs/cn-quickstart/quickstart/integration-test/node_modules
            /home/runner/.daml
            /home/runner/.gradle
          key: quickstart-prep-${{ runner.os }}-${{ hashFiles('package.json', 'package-lock.json') }}-${{ steps.submodule-cache-key.outputs.value }}

      - name: Verify Cached Prerequisites
        id: verify-cache
        run: |
          set -euo pipefail

          if [ -d "node_modules" ]; then
            echo "has_node_modules=true" >> $GITHUB_OUTPUT
          else
            echo "has_node_modules=false" >> $GITHUB_OUTPUT
          fi

          if [ -f "libs/cn-quickstart/quickstart/.env.local" ]; then
            echo "has_quickstart_env=true" >> $GITHUB_OUTPUT
          else
            echo "has_quickstart_env=false" >> $GITHUB_OUTPUT
          fi

          if [ -x "$HOME/.daml/bin/daml" ]; then
            echo "has_daml=true" >> $GITHUB_OUTPUT
          else
            echo "has_daml=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Dependencies
        if: steps.verify-cache.outputs.has_node_modules != 'true'
        run: npm install

      - name: Run Linter
        run: npm run fix

      - name: Check for Lint Changes
        id: lint-changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and Push Lint Fixes
        if: steps.lint-changes.outputs.has_changes == 'true' && github.event_name == 'push'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "chore: auto-fix linting issues [skip ci]"
          git push

      - name: Setup CN-Quickstart
        if: steps.verify-cache.outputs.has_quickstart_env != 'true'
        run: |
          cd libs/cn-quickstart/quickstart
          echo "Running setup with OAuth2..."
          # Setup with OAuth2 non-interactively
          echo "2" | make setup || true  # Select option 2 (with OAuth2)
          echo "✓ CN-Quickstart setup complete"
        timeout-minutes: 15

      - name: Install Daml SDK
        if: steps.verify-cache.outputs.has_daml != 'true'
        run: |
          cd libs/cn-quickstart/quickstart
          make install-daml-sdk
        timeout-minutes: 15

      - name: Add Daml CLI to PATH
        run: echo "$HOME/.daml/bin" >> $GITHUB_PATH

      - name: Start CN-Quickstart
        run: |
          cd libs/cn-quickstart/quickstart
          make start
          echo "✓ CN-Quickstart started"
        timeout-minutes: 15

      - name: Wait for Services
        run: |
          echo "Waiting for Keycloak..."
          for i in {1..30}; do
            if curl -f http://localhost:8082/realms/AppProvider 2>/dev/null; then
              echo "✓ Keycloak is ready"
              break
            fi
            echo "Waiting for Keycloak... ($i/30)"
            sleep 10
          done

          echo "Waiting for Validator API..."
          for i in {1..30}; do
            if curl -f http://localhost:3903/api/validator/v0/wallet/user-status 2>/dev/null || [ $? -eq 22 ]; then
              echo "✓ Validator API is responding"
              break
            fi
            echo "Waiting for Validator API... ($i/30)"
            sleep 10
          done

          echo "✓ All services are ready!"

      # Cache the prepared quickstart environment to speed up subsequent runs.
      # This cache will be invalidated when:
      # - package.json changes (dependency additions/removals)
      # - package-lock.json changes (exact dependency versions)
      # - libs/cn-quickstart submodule HEAD changes (submodule updated to different commit)
      # - libs/splice submodule HEAD changes (submodule updated to different commit)
      # - Runner OS changes (unlikely in practice)
      - name: Save Quickstart Preparation Cache
        if: steps.quickstart-prep-cache-restore.outputs.cache-hit != 'true'
        id: quickstart-prep-cache-save
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ github.workspace }}/node_modules
            ${{ github.workspace }}/artifacts
            ${{ github.workspace }}/build
            ${{ github.workspace }}/libs/cn-quickstart/quickstart/.env.local
            ${{ github.workspace }}/libs/cn-quickstart/quickstart/.gradle
            ${{ github.workspace }}/libs/cn-quickstart/quickstart/.daml
            ${{ github.workspace }}/libs/cn-quickstart/quickstart/.config
            ${{ github.workspace }}/libs/cn-quickstart/quickstart/.cache
            ${{ github.workspace }}/libs/cn-quickstart/quickstart/frontend/node_modules
            ${{ github.workspace }}/libs/cn-quickstart/quickstart/frontend/dist
            ${{ github.workspace }}/libs/cn-quickstart/quickstart/backend/build
            ${{ github.workspace }}/libs/cn-quickstart/quickstart/integration-test/node_modules
            /home/runner/.daml
            /home/runner/.gradle
          key: ${{ steps.quickstart-prep-cache-restore.outputs.cache-primary-key }}

      - name: Build SDK
        run: npm run build

      - name: Run Smoke Tests
        run: |
          echo "Running tests..."
          npm run test
          echo "✓ Tests passed!"

      - name: Show Logs on Failure
        if: failure()
        run: |
          echo "==================== Docker Containers ===================="
          docker ps -a || true

          echo "==================== Docker Compose Logs ===================="
          if [ -d "libs/cn-quickstart/quickstart" ]; then
            cd libs/cn-quickstart/quickstart
            docker compose logs --tail=100 || true
          fi

          echo "==================== Canton Logs ===================="
          if [ -f libs/cn-quickstart/quickstart/logs/canton.log ]; then
            tail -100 libs/cn-quickstart/quickstart/logs/canton.log
          fi
