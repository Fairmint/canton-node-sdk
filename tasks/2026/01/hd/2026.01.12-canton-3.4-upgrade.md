# Task: Canton 3.4 SDK Upgrade

**Date**: 2026-01-12
**Author**: HD
**Status**: Completed
**Branch**: `cursor/canton-3-4-upgrade-73bd`

## Goal

Upgrade the Canton Node SDK to support Canton 3.4, ensuring compatibility with the latest Ledger JSON API, Validator API, and Scan API changes.

## Context

Canton 3.4 introduces API changes that require updates to our SDK. The Digital Asset Canton releases are now at v3.4.10, and our SDK documentation already references Canton 3.4. This task ensures our schemas, types, and operations are fully aligned with Canton 3.4.

**Current SDK state:**
- `@canton-network/wallet-sdk`: 0.19.1
- `hyperledger-labs/splice` submodule: commit d5ee20c2
- Ledger JSON API docs reference: 3.4

## Scope

### In Scope

- [x] Update `libs/splice` submodule to latest Canton 3.4 compatible tag
- [x] Regenerate OpenAPI types from updated specs
- [x] Update Zod schemas to match any API changes
- [x] Update operation implementations for new/changed endpoints
- [x] Update `@canton-network/wallet-sdk` if new version available (no new version available)
- [x] Add tests for any new functionality
- [x] Update documentation

### Out of Scope

- Breaking changes to SDK public API without deprecation
- Support for Canton 2.x
- New utility functions (unless required for 3.4 compatibility)

## Implementation Plan

### Phase 1: Dependency Updates

#### 1.1 Update splice Submodule

Update to the latest Canton 3.4 compatible release:

```bash
cd libs/splice
git fetch --tags
git checkout <latest-3.4-compatible-tag>
cd ../..
git add libs/splice
```

#### 1.2 Regenerate OpenAPI Types

```bash
npm run generate:openapi-types
npm run build:core
```

Review changes in `src/generated/` for any breaking API changes.

#### 1.3 Update wallet-sdk (if needed)

Check for new `@canton-network/wallet-sdk` releases that support Canton 3.4:

```bash
npm view @canton-network/wallet-sdk versions --json | jq '.[-5:]'
```

If new version exists:
```bash
npm install @canton-network/wallet-sdk@<version> --save-exact
```

### Phase 2: Schema Updates

#### 2.1 Review API Changes

Compare generated types with existing Zod schemas:

| API | Schema Files |
|-----|-------------|
| Ledger JSON API | `src/clients/ledger-json-api/schemas/` |
| Validator API | `src/clients/validator-api/schemas/` |
| Scan API | `src/clients/scan-api/` |

Common areas that change between Canton versions:
- Transaction/command schemas
- Party/user metadata fields
- Interactive submission schemas
- WebSocket update schemas

#### 2.2 Update Zod Schemas

For each schema change:
1. Update the schema definition
2. Update the TypeScript type export
3. Add/update JSDoc comments
4. Run tests to verify

**Files to review:**
- `src/clients/ledger-json-api/schemas/api/` - API response schemas
- `src/clients/ledger-json-api/schemas/operations/` - Request parameter schemas
- `src/clients/ledger-json-api/schemas/common.ts` - Shared types

### Phase 3: Operation Updates

#### 3.1 Update Changed Operations

For any operations with breaking changes:
1. Update the operation implementation
2. Update request/response types
3. Maintain backward compatibility where possible
4. Add deprecation notices if needed

#### 3.2 Add New Operations

If Canton 3.4 introduces new endpoints:
1. Create operation class in appropriate directory
2. Add to client class methods
3. Export from index files
4. Add JSDoc documentation
5. Generate client methods: `npm run build:core:generate-client-methods`

### Phase 4: Testing

#### 4.1 Update Existing Tests

```bash
npm test
```

Fix any failing tests due to schema/API changes.

#### 4.2 Add Tests for New Functionality

For each new operation or changed behavior:
- Add unit tests with mocked responses
- Add integration tests (if LocalNet supports 3.4)

### Phase 5: Documentation

#### 5.1 Update API Documentation

```bash
npm run docs
```

Review generated docs in `docs/` for accuracy.

#### 5.2 Update Changelog

Add entry to the task's Change Log section (below).

---

## Testing Strategy

### Automated Tests

- [ ] All existing unit tests pass
- [ ] Schema validation tests cover new/changed schemas
- [ ] Operation tests verify correct URL building and response parsing

### Manual Testing

- [ ] Test against LocalNet (if cn-quickstart supports Canton 3.4)
- [ ] Verify OAuth2 authentication flow
- [ ] Test key operations: party creation, transactions, queries

### CI Verification

```bash
npm run lint && npm run build && npm test
```

---

## Success Criteria

- [x] `libs/splice` submodule updated to Canton 3.4 compatible version
- [x] All generated types regenerated without errors
- [x] All Zod schemas aligned with Canton 3.4 API
- [x] All unit tests passing
- [x] Build completes without errors or warnings
- [x] Documentation updated

---

## Implementation Checklist

- [x] Phase 1: Dependency Updates
  - [x] Update splice submodule
  - [x] Regenerate OpenAPI types
  - [x] Update wallet-sdk (if applicable) — no new version available
- [x] Phase 2: Schema Updates
  - [x] Review API changes
  - [x] Update Zod schemas
- [x] Phase 3: Operation Updates
  - [x] Update changed operations
  - [x] Add new operations (if any) — no new operations needed
- [x] Phase 4: Testing
  - [x] Fix failing tests
  - [x] Add new tests — no new tests needed
- [x] Phase 5: Documentation
  - [x] Update API docs
  - [x] Update changelog

---

## Files Requiring Attention

### Submodules
- `libs/splice` — Update to Canton 3.4 compatible tag

### Generated Files
- `src/generated/**/*.ts` — Regenerate from OpenAPI specs

### Schema Files
- `src/clients/ledger-json-api/schemas/api/*.ts`
- `src/clients/ledger-json-api/schemas/operations/*.ts`
- `src/clients/ledger-json-api/schemas/common.ts`
- `src/clients/validator-api/schemas/**/*.ts`

### Operation Files
- `src/clients/ledger-json-api/operations/v2/**/*.ts`
- `src/clients/validator-api/operations/v0/**/*.ts`
- `src/clients/scan-api/operations/v0/*.ts`

### Dependencies
- `package.json` — Update `@canton-network/wallet-sdk` if needed

---

## Known Canton 3.4 Changes

*Document specific API changes discovered during implementation:*

| Change Type | Description | Impact |
|-------------|-------------|--------|
| New Required Field | `GetChoiceContextRequest` now requires `excludeDebugFields` boolean (defaults to `false`) | Updated 6 operations with the new parameter |

---

## Notes / Decisions Made

- Updated `libs/splice` from commit `d5ee20c2` to tag `0.5.5` (Canton 3.4.9)
- The `@canton-network/wallet-sdk` remains at version `0.19.1` as no new version is available
- Added `excludeDebugFields` optional parameter to 6 scan-proxy/registry operations
- All 317 unit tests pass; integration tests require LocalNet which is not available in this environment

---

## Change Log

### 2026-01-13 — Task Completed

**Status:** Completed

- Updated `libs/splice` submodule to tag `0.5.5` (Canton 3.4.9)
- Regenerated OpenAPI types from updated specs
- Updated 6 operations to include new `excludeDebugFields` parameter:
  - `get-allocation-cancel-context.ts`
  - `get-allocation-transfer-context.ts`
  - `get-allocation-withdraw-context.ts`
  - `get-transfer-instruction-accept-context.ts`
  - `get-transfer-instruction-reject-context.ts`
  - `get-transfer-instruction-withdraw-context.ts`
- All builds pass without errors
- All 317 unit tests pass
- Documentation regenerated

### 2026-01-12 — Task Created

**Status:** Planning phase

- Created task file for Canton 3.4 upgrade
- Identified key areas requiring updates:
  - `libs/splice` submodule
  - OpenAPI generated types
  - Zod schemas
  - Operation implementations

---

*Last updated: 2026-01-13*
