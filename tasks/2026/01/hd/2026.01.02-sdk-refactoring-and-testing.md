# Task: SDK Refactoring and Testing Plan

**Date**: 2026-01-02
**Author**: HD
**Status**: Planning
**PR**: (to be created after approval)

## Goal

Improve SDK quality, test coverage, and developer experience through comprehensive testing and targeted refactoring.

## Context

The SDK has a solid foundation with good architecture patterns (BaseClient, ApiOperation factory, code generation). However, it lacks comprehensive testing and has opportunities for API ergonomics improvements. With LocalNet available, we can now add thorough integration tests and refactor utilities to be more user-friendly.

**Current testing state:**
- Only 3 test files exist
- Most utility functions have zero test coverage
- External signing, party creation, and transfer operations are untested

## Scope

### In Scope

- [ ] Add true LocalNet integration tests
- [ ] Add unit tests for all utility functions
- [ ] Add schema validation tests
- [ ] Add error handling tests
- [ ] Add high-level `Canton` facade class
- [ ] Replace hardcoded waits with polling utilities
- [ ] Standardize error messages
- [ ] Add request/response logging middleware
- [ ] Consolidate operation patterns
- [ ] Improve code generation
- [ ] Add comprehensive JSDoc
- [ ] Add more examples

### Out of Scope

- Breaking API changes to existing public interfaces
- Complete rewrite of core client infrastructure
- Migration tooling for existing users

## Implementation Plan

### Phase 1: Testing Foundation (1-2 weeks)

#### 1.1 Add True LocalNet Integration Tests

**Goal**: Test actual SDK operations against a running LocalNet instance.

```typescript
// test/integration/localnet/ledger-api.test.ts
describe('LedgerJsonApiClient Integration', () => {
  it('creates a party and submits a transaction', async () => {
    // Real end-to-end test
  });
});
```

**Tests to add:**
- `ledger-json-api/` - Party management, user management, commands, transactions
- `validator-api/` - Wallet operations, transfer offers, balance queries
- `scan-api/` - Read operations, contract lookups
- `websocket/` - Updates subscription, completion streaming

**Files to create:**
- `test/integration/localnet/ledger-api.test.ts`
- `test/integration/localnet/validator-api.test.ts`
- `test/integration/localnet/scan-api.test.ts`
- `test/integration/localnet/websocket.test.ts`

#### 1.2 Add Unit Tests for Utility Functions

**Untested utilities that need coverage:**

| Utility | File | Priority |
|---------|------|----------|
| `createParty` | `src/utils/party/createParty.ts` | High |
| `createTransferOffer` | `src/utils/amulet/offers.ts` | High |
| `acceptTransferOffer` | `src/utils/amulet/offers.ts` | High |
| `transferToPreapproved` | `src/utils/amulet/transfer-to-preapproved.ts` | High |
| `preApproveTransfers` | `src/utils/amulet/pre-approve-transfers.ts` | High |
| `getAmuletsForTransfer` | `src/utils/amulet/get-amulets-for-transfer.ts` | Medium |
| `getLockedAmulets` | `src/utils/amulet/get-locked-amulets.ts` | Medium |
| `createExternalParty` | `src/utils/external-signing/create-external-party.ts` | High |
| `prepareExternalTransaction` | `src/utils/external-signing/prepare-external-transaction.ts` | High |
| `executeExternalTransaction` | `src/utils/external-signing/execute-external-transaction.ts` | High |
| `getCurrentMiningRoundContext` | `src/utils/mining/mining-rounds.ts` | Medium |
| `findCreatedEventByTemplateId` | `src/utils/contracts/findCreatedEvent.ts` | Medium |
| `TransactionBatch` | `src/utils/transactions/TransactionBatch.ts` | Medium |

#### 1.3 Add Schema Validation Tests

Test that Zod schemas correctly validate API responses:

```typescript
// test/unit/schemas/commands.test.ts
describe('Command Schemas', () => {
  it('validates CreateCommand structure', () => {
    const result = CreateCommandSchema.safeParse({ /* ... */ });
    expect(result.success).toBe(true);
  });
});
```

#### 1.4 Add Error Handling Tests

Test error scenarios and edge cases:
- Network failures and retries
- Authentication errors
- API error responses
- Validation failures

---

### Phase 2: API Ergonomics (2-3 weeks)

#### 2.1 Simplify Common Workflows

**Current (verbose):**
```typescript
const ledgerClient = new LedgerJsonApiClient({ network: 'localnet' });
const validatorClient = new ValidatorApiClient({ network: 'localnet' });

const transferOfferContractId = await createTransferOffer({
  ledgerClient,
  receiverPartyId: 'recipient',
  amount: '100',
  description: 'Payment',
});

await acceptTransferOffer({
  ledgerClient,
  transferOfferContractId,
  acceptingPartyId: 'recipient',
});
```

**Proposed (unified client access):**
```typescript
import { Canton } from '@fairmint/canton-node-sdk';

const canton = new Canton({ network: 'localnet' });

// Unified client access
await canton.transfers.send({
  to: 'recipient',
  amount: '100',
  description: 'Payment',
});
```

#### 2.2 Add High-Level Facade

Create a unified entry point that abstracts away the multiple clients:

```typescript
// src/Canton.ts (proposed)
export class Canton {
  public readonly ledger: LedgerJsonApiClient;
  public readonly validator: ValidatorApiClient;
  public readonly scan: ScanApiClient;
  
  // High-level operations
  public readonly parties: PartyOperations;
  public readonly transfers: TransferOperations;
  public readonly contracts: ContractOperations;
  
  constructor(config: CantonConfig) {
    // Initialize all clients with shared config
  }
}
```

**Files to create:**
- `src/Canton.ts`
- `src/operations/PartyOperations.ts`
- `src/operations/TransferOperations.ts`
- `src/operations/ContractOperations.ts`

---

### Phase 3: Code Quality (1-2 weeks)

#### 3.1 Remove Hardcoded Waits

**Problem:** Several utilities use hardcoded `setTimeout`:

```typescript
// src/utils/party/createParty.ts:66
await new Promise((resolve) => setTimeout(resolve, 30000));
```

**Solution:** Replace with polling/retry utilities:

```typescript
// src/core/utils/polling.ts
export async function waitForCondition<T>(
  check: () => Promise<T | null>,
  options: { timeout: number; interval: number }
): Promise<T> {
  // Poll until condition is met or timeout
}

// Usage
await waitForCondition(
  () => client.getContractById(contractId),
  { timeout: 30000, interval: 1000 }
);
```

**Files to modify:**
- `src/utils/party/createParty.ts` — Replace 30s wait with polling
- `src/utils/mining/mining-rounds.ts` — Replace sleep with polling

**Files to create:**
- `src/core/utils/polling.ts`

#### 3.2 Improve Type Safety

**Problem:** Some places use `unknown` with type assertions.

**Solution:** Add proper generics and constraints to eliminate assertions.

**Files to modify:**
- `src/core/operations/ApiOperationFactory.ts`
- `src/utils/transactions/find-created-event.ts`

#### 3.3 Standardize Error Messages

Create consistent error message patterns:

```typescript
// Current (inconsistent)
throw new Error(`No domain ID found for transfer preapproval for party ${partyId}`);
throw new Error('No valid open mining round found');

// Proposed (structured)
throw new CantonError(
  'No domain ID found for transfer preapproval',
  'MISSING_DOMAIN_ID',
  { partyId }
);
```

**Files to modify:**
- `src/utils/party/createParty.ts`
- `src/utils/amulet/transfer-to-preapproved.ts`
- `src/utils/mining/mining-rounds.ts`

#### 3.4 Add Request/Response Logging Middleware

Improve debugging with structured logging:

```typescript
// Enable debug logging
const canton = new Canton({
  network: 'localnet',
  debug: true, // Logs all requests/responses
});
```

---

### Phase 4: Architecture & Docs (ongoing)

#### 4.1 Consolidate Operation Patterns

**Current:** Mix of class-based and factory-based operations:

```typescript
// Factory pattern (newer)
export const GetVersion = createApiOperation<...>({ ... });

// Class pattern (older)
export class SubscribeToUpdates {
  public async connect(params) { ... }
}
```

**Recommendation:** Standardize on factory pattern for REST, keep classes for WebSocket.

#### 4.2 Improve Code Generation

The `generate-all-client-methods.ts` script could be improved:

- Add JSDoc comments to generated methods
- Generate parameter type exports for better autocomplete
- Generate response type exports

**Files to modify:**
- `scripts/generate-all-client-methods.ts`

#### 4.3 Add Response Transformers

Normalize API responses to consistent shapes:

```typescript
// Raw API response
{ party_id: 'alice::123', user_name: 'alice' }

// Transformed to camelCase
{ partyId: 'alice::123', userName: 'alice' }
```

#### 4.4 Simplify Configuration

The `EnvLoader` class is complex (480 lines). Consider:

- Split into smaller focused loaders
- Add configuration validation on startup
- Support configuration files (JSON/YAML)

**Files to modify:**
- `src/core/config/EnvLoader.ts`

#### 4.5 Add JSDoc to All Public APIs

Every public method should have:
- Description
- Parameter documentation
- Return type documentation
- Example usage

#### 4.6 Add More Examples

Current examples are minimal. Add:
- `examples/create-party.ts`
- `examples/transfer-amulets.ts`
- `examples/subscribe-to-updates.ts`
- `examples/external-signing-flow.ts`
- `examples/batch-transactions.ts`

#### 4.7 Add Troubleshooting Guide

Document common errors and solutions at `docs/TROUBLESHOOTING.md`.

---

## Testing Strategy

### Automated Tests

- [ ] Unit tests for all utility functions
- [ ] Schema validation tests for all Zod schemas
- [ ] Integration tests against LocalNet for all client operations
- [ ] Error handling tests for network failures, auth errors, validation failures

### Test Utilities

Create reusable test helpers:

```typescript
// test/helpers/localnet.ts
export async function withLocalNetClient<T>(
  fn: (clients: { ledger: LedgerJsonApiClient; validator: ValidatorApiClient }) => Promise<T>
): Promise<T> {
  const ledger = new LedgerJsonApiClient({ network: 'localnet' });
  const validator = new ValidatorApiClient({ network: 'localnet' });
  
  try {
    return await fn({ ledger, validator });
  } finally {
    // Cleanup if needed
  }
}

// test/helpers/fixtures.ts
export function createTestParty(name: string): PartyFixture {
  // Create deterministic test data
}
```

### Test Categories

Organize tests by type:

```
test/
  unit/           # Fast, no external dependencies
  integration/    # Requires LocalNet
  e2e/           # Full workflow tests
```

### CI Integration

Ensure all test types run in CI:

```yaml
# .github/workflows/test.yml
jobs:
  unit:
    runs-on: ubuntu-latest
    steps:
      - run: npm run test:unit
      
  integration:
    runs-on: ubuntu-latest
    services:
      localnet: ...
    steps:
      - run: npm run test:integration
```

---

## Success Criteria

- [ ] All high-priority utility functions have unit tests
- [ ] Integration tests cover main client operations
- [ ] No hardcoded waits in production code
- [ ] Error messages follow consistent pattern
- [ ] High-level `Canton` facade available for common workflows
- [ ] All tests pass in CI

---

## Implementation Checklist

- [ ] Phase 1: Testing Foundation
  - [ ] LocalNet integration test infrastructure
  - [ ] Unit tests for core utilities
  - [ ] Schema validation tests
  - [ ] Error handling tests
- [ ] Phase 2: API Ergonomics
  - [ ] High-level `Canton` facade
  - [ ] Transfer operations helper
  - [ ] Party operations helper
- [ ] Phase 3: Code Quality
  - [ ] Replace hardcoded waits
  - [ ] Standardize error messages
  - [ ] Add request/response logging
- [ ] Phase 4: Architecture & Docs
  - [ ] Consolidate operation patterns
  - [ ] Improve code generation
  - [ ] Add comprehensive JSDoc
  - [ ] Add examples
- [ ] Tests passing
- [ ] Documentation updated

---

## Files Requiring Attention

### High Priority (need tests + refactoring)
- `src/utils/party/createParty.ts` - Hardcoded wait, no tests
- `src/utils/amulet/transfer-to-preapproved.ts` - Complex, no tests
- `src/utils/external-signing/*.ts` - Critical flow, no tests

### Medium Priority (need tests)
- `src/utils/amulet/offers.ts`
- `src/utils/amulet/pre-approve-transfers.ts`
- `src/utils/mining/mining-rounds.ts`
- `src/core/http/HttpClient.ts` - Retry logic untested

### Lower Priority (improve ergonomics)
- `src/core/BaseClient.ts` - Could be simplified
- `src/core/config/EnvLoader.ts` - Too complex
- `src/clients/ledger-json-api/operations/` - JSDoc improvements

## Notes / Decisions Made

(Log changes from original plan as implementation proceeds)

---

## Backlog / Future Work

### Test Data Population on LocalNet

**Priority**: Medium
**Context**: Current integration tests only verify that API calls succeed and return expected types. Many tests (e.g., `listTransferOffers`, `listAnsEntries`) return empty arrays because no test data exists on LocalNet.

**TODO**:
- [ ] Create test fixtures that populate LocalNet with sample data before tests run
- [ ] Add transfer offer creation in test setup so `listTransferOffers` returns actual offers
- [ ] Add ANS entry creation so `listAnsEntries` returns actual entries
- [ ] Verify response formatting and field values, not just array types
- [ ] Consider using `beforeAll` hooks to create test data once per test suite

**Example improvement for transfers.test.ts**:
```typescript
// Current (basic)
expect(Array.isArray(response.offers)).toBe(true);

// Future (with test data)
expect(response.offers.length).toBeGreaterThan(0);
expect(response.offers[0]).toHaveProperty('contract_id');
expect(response.offers[0]).toHaveProperty('amount');
```

---
*Last updated: 2026-01-02*
