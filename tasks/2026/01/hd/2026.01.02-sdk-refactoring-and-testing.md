# Task: SDK Refactoring and Testing Plan

**Date**: 2026-01-02 **Author**: HD **Status**: Completed **PR**: (to be created after approval)

## Goal

Improve SDK quality, test coverage, and developer experience through comprehensive testing and
targeted refactoring.

## Context

The SDK has a solid foundation with good architecture patterns (BaseClient, ApiOperation factory,
code generation). However, it lacks comprehensive testing and has opportunities for API ergonomics
improvements. With LocalNet available, we can now add thorough integration tests and refactor
utilities to be more user-friendly.

**Current testing state:**

- Only 3 test files exist
- Most utility functions have zero test coverage
- External signing, party creation, and transfer operations are untested

## Scope

### In Scope

- [x] Add true LocalNet integration tests
- [x] Add unit tests for all utility functions
- [x] Add schema validation tests
- [x] Add error handling tests
- [x] Add high-level `Canton` facade class
- [x] Replace hardcoded waits with polling utilities
- [x] Standardize error messages
- [x] Add request/response logging middleware
- [x] Consolidate operation patterns
- [x] Improve code generation
- [x] Add comprehensive JSDoc
- [x] Add more examples

### Out of Scope

- Breaking API changes to existing public interfaces
- Complete rewrite of core client infrastructure
- Migration tooling for existing users

## Implementation Plan

### Phase 1: Testing Foundation (1-2 weeks)

#### 1.1 Add True LocalNet Integration Tests

**Goal**: Test actual SDK operations against a running LocalNet instance.

```typescript
// test/integration/localnet/ledger-api.test.ts
describe('LedgerJsonApiClient Integration', () => {
  it('creates a party and submits a transaction', async () => {
    // Real end-to-end test
  });
});
```

**Tests to add:**

- `ledger-json-api/` - Party management, user management, commands, transactions
- `validator-api/` - Wallet operations, transfer offers, balance queries
- `scan-api/` - Read operations, contract lookups
- `websocket/` - Updates subscription, completion streaming

**Files to create:**

- `test/integration/localnet/ledger-api.test.ts`
- `test/integration/localnet/validator-api.test.ts`
- `test/integration/localnet/scan-api.test.ts`
- `test/integration/localnet/websocket.test.ts`

#### 1.2 Add Unit Tests for Utility Functions

**Untested utilities that need coverage:**

| Utility                        | File                                                         | Priority |
| ------------------------------ | ------------------------------------------------------------ | -------- |
| `createParty`                  | `src/utils/party/createParty.ts`                             | High     |
| `createTransferOffer`          | `src/utils/amulet/offers.ts`                                 | High     |
| `acceptTransferOffer`          | `src/utils/amulet/offers.ts`                                 | High     |
| `transferToPreapproved`        | `src/utils/amulet/transfer-to-preapproved.ts`                | High     |
| `preApproveTransfers`          | `src/utils/amulet/pre-approve-transfers.ts`                  | High     |
| `getAmuletsForTransfer`        | `src/utils/amulet/get-amulets-for-transfer.ts`               | Medium   |
| `getLockedAmulets`             | `src/utils/amulet/get-locked-amulets.ts`                     | Medium   |
| `createExternalParty`          | `src/utils/external-signing/create-external-party.ts`        | High     |
| `prepareExternalTransaction`   | `src/utils/external-signing/prepare-external-transaction.ts` | High     |
| `executeExternalTransaction`   | `src/utils/external-signing/execute-external-transaction.ts` | High     |
| `getCurrentMiningRoundContext` | `src/utils/mining/mining-rounds.ts`                          | Medium   |
| `findCreatedEventByTemplateId` | `src/utils/contracts/findCreatedEvent.ts`                    | Medium   |
| `TransactionBatch`             | `src/utils/transactions/TransactionBatch.ts`                 | Medium   |

#### 1.3 Add Schema Validation Tests

Test that Zod schemas correctly validate API responses:

```typescript
// test/unit/schemas/commands.test.ts
describe('Command Schemas', () => {
  it('validates CreateCommand structure', () => {
    const result = CreateCommandSchema.safeParse({
      /* ... */
    });
    expect(result.success).toBe(true);
  });
});
```

#### 1.4 Add Error Handling Tests

Test error scenarios and edge cases:

- Network failures and retries
- Authentication errors
- API error responses
- Validation failures

---

### Phase 2: API Ergonomics (2-3 weeks)

#### 2.1 Simplify Common Workflows

**Current (verbose):**

```typescript
const ledgerClient = new LedgerJsonApiClient({ network: 'localnet' });
const validatorClient = new ValidatorApiClient({ network: 'localnet' });

const transferOfferContractId = await createTransferOffer({
  ledgerClient,
  receiverPartyId: 'recipient',
  amount: '100',
  description: 'Payment',
});

await acceptTransferOffer({
  ledgerClient,
  transferOfferContractId,
  acceptingPartyId: 'recipient',
});
```

**Proposed (unified client access):**

```typescript
import { Canton } from '@fairmint/canton-node-sdk';

const canton = new Canton({ network: 'localnet' });

// Unified client access
await canton.transfers.send({
  to: 'recipient',
  amount: '100',
  description: 'Payment',
});
```

#### 2.2 Add High-Level Facade

Create a unified entry point that abstracts away the multiple clients:

```typescript
// src/Canton.ts (proposed)
export class Canton {
  public readonly ledger: LedgerJsonApiClient;
  public readonly validator: ValidatorApiClient;
  public readonly scan: ScanApiClient;

  // High-level operations
  public readonly parties: PartyOperations;
  public readonly transfers: TransferOperations;
  public readonly contracts: ContractOperations;

  constructor(config: CantonConfig) {
    // Initialize all clients with shared config
  }
}
```

**Files to create:**

- `src/Canton.ts`
- `src/operations/PartyOperations.ts`
- `src/operations/TransferOperations.ts`
- `src/operations/ContractOperations.ts`

---

### Phase 3: Code Quality (1-2 weeks)

#### 3.1 Remove Hardcoded Waits

**Problem:** Several utilities use hardcoded `setTimeout`:

```typescript
// src/utils/party/createParty.ts:66
await new Promise((resolve) => setTimeout(resolve, 30000));
```

**Solution:** Replace with polling/retry utilities:

```typescript
// src/core/utils/polling.ts
export async function waitForCondition<T>(
  check: () => Promise<T | null>,
  options: { timeout: number; interval: number }
): Promise<T> {
  // Poll until condition is met or timeout
}

// Usage
await waitForCondition(() => client.getContractById(contractId), {
  timeout: 30000,
  interval: 1000,
});
```

**Files to modify:**

- `src/utils/party/createParty.ts` — Replace 30s wait with polling
- `src/utils/mining/mining-rounds.ts` — Replace sleep with polling

**Files to create:**

- `src/core/utils/polling.ts`

#### 3.2 Improve Type Safety

**Problem:** Some places use `unknown` with type assertions.

**Solution:** Add proper generics and constraints to eliminate assertions.

**Files to modify:**

- `src/core/operations/ApiOperationFactory.ts`
- `src/utils/transactions/find-created-event.ts`

#### 3.3 Standardize Error Messages

Create consistent error message patterns:

```typescript
// Current (inconsistent)
throw new Error(`No domain ID found for transfer preapproval for party ${partyId}`);
throw new Error('No valid open mining round found');

// Proposed (structured)
throw new CantonError('No domain ID found for transfer preapproval', 'MISSING_DOMAIN_ID', {
  partyId,
});
```

**Files to modify:**

- `src/utils/party/createParty.ts`
- `src/utils/amulet/transfer-to-preapproved.ts`
- `src/utils/mining/mining-rounds.ts`

#### 3.4 Add Request/Response Logging Middleware

Improve debugging with structured logging:

```typescript
// Enable debug logging
const canton = new Canton({
  network: 'localnet',
  debug: true, // Logs all requests/responses
});
```

---

### Phase 4: Architecture & Docs (ongoing)

#### 4.1 Consolidate Operation Patterns

**Current:** Mix of class-based and factory-based operations:

```typescript
// Factory pattern (newer)
export const GetVersion = createApiOperation<...>({ ... });

// Class pattern (older)
export class SubscribeToUpdates {
  public async connect(params) { ... }
}
```

**Recommendation:** Standardize on factory pattern for REST, keep classes for WebSocket.

#### 4.2 Improve Code Generation

The `generate-all-client-methods.ts` script could be improved:

- Add JSDoc comments to generated methods
- Generate parameter type exports for better autocomplete
- Generate response type exports

**Files to modify:**

- `scripts/generate-all-client-methods.ts`

#### 4.3 Add Response Transformers

Normalize API responses to consistent shapes:

```typescript
// Raw API response
{ party_id: 'alice::123', user_name: 'alice' }

// Transformed to camelCase
{ partyId: 'alice::123', userName: 'alice' }
```

#### 4.4 Simplify Configuration

The `EnvLoader` class is complex (480 lines). Consider:

- Split into smaller focused loaders
- Add configuration validation on startup
- Support configuration files (JSON/YAML)

**Files to modify:**

- `src/core/config/EnvLoader.ts`

#### 4.5 Add JSDoc to All Public APIs

Every public method should have:

- Description
- Parameter documentation
- Return type documentation
- Example usage

#### 4.6 Add More Examples

Current examples are minimal. Add:

- `examples/create-party.ts`
- `examples/transfer-amulets.ts`
- `examples/subscribe-to-updates.ts`
- `examples/external-signing-flow.ts`
- `examples/batch-transactions.ts`

#### 4.7 Add Troubleshooting Guide

Document common errors and solutions at `docs/TROUBLESHOOTING.md`.

---

## Testing Strategy

### Automated Tests

- [ ] Unit tests for all utility functions
- [ ] Schema validation tests for all Zod schemas
- [ ] Integration tests against LocalNet for all client operations
- [ ] Error handling tests for network failures, auth errors, validation failures

### Test Utilities

Create reusable test helpers:

```typescript
// test/helpers/localnet.ts
export async function withLocalNetClient<T>(
  fn: (clients: { ledger: LedgerJsonApiClient; validator: ValidatorApiClient }) => Promise<T>
): Promise<T> {
  const ledger = new LedgerJsonApiClient({ network: 'localnet' });
  const validator = new ValidatorApiClient({ network: 'localnet' });

  try {
    return await fn({ ledger, validator });
  } finally {
    // Cleanup if needed
  }
}

// test/helpers/fixtures.ts
export function createTestParty(name: string): PartyFixture {
  // Create deterministic test data
}
```

### Test Categories

Organize tests by type:

```
test/
  unit/           # Fast, no external dependencies
  integration/    # Requires LocalNet
  e2e/           # Full workflow tests
```

### CI Integration

Ensure all test types run in CI:

```yaml
# .github/workflows/test.yml
jobs:
  unit:
    runs-on: ubuntu-latest
    steps:
      - run: npm run test:unit

  integration:
    runs-on: ubuntu-latest
    services:
      localnet: ...
    steps:
      - run: npm run test:integration
```

---

## Success Criteria

- [x] All high-priority utility functions have unit tests
- [x] Integration tests cover main client operations (test infrastructure exists, tests run with
      LocalNet)
- [x] No hardcoded waits in production code (replaced with polling utilities)
- [x] Error messages follow consistent pattern (OperationError class with error codes)
- [x] High-level `Canton` facade available for common workflows
- [x] All tests pass in CI (unit tests; integration requires LocalNet)

---

## Implementation Checklist

- [x] Phase 1: Testing Foundation
  - [x] LocalNet integration test infrastructure
  - [x] Unit tests for core utilities
  - [x] Schema validation tests
  - [x] Error handling tests
- [x] Phase 2: API Ergonomics
  - [x] High-level `Canton` facade
  - [~] Transfer operations helper (using utility functions instead)
  - [~] Party operations helper (using utility functions instead)
- [x] Phase 3: Code Quality
  - [x] Replace hardcoded waits
  - [x] Standardize error messages (OperationError class)
  - [x] Request/response logging middleware (ConsoleLogger, CompositeLogger, debug option)
- [x] Phase 4: Architecture & Docs
  - [x] Consolidate operation patterns
  - [x] Improve code generation (JSDoc comments added)
  - [x] Add comprehensive JSDoc
  - [x] Add examples
- [x] Tests passing (306 unit tests)
- [x] Documentation updated

---

## Files Requiring Attention

### Completed (have tests now)

- ✅ `src/utils/party/createParty.ts` - Tests added, uses polling utilities, uses ValidationError
- ✅ `src/utils/amulet/transfer-to-preapproved.ts` - Tests added, uses
  OperationError/ValidationError
- ✅ `src/utils/external-signing/*.ts` - Tests added for all files, uses OperationError
- ✅ `src/utils/amulet/offers.ts` - Tests added, uses OperationError
- ✅ `src/utils/amulet/pre-approve-transfers.ts` - Tests added, uses OperationError
- ✅ `src/utils/mining/mining-rounds.ts` - Tests added, uses OperationError
- ✅ `src/utils/contracts/featuredAppRight.ts` - Tests added, uses OperationError
- ✅ `src/core/errors.ts` - OperationError class added with error codes

### Lower Priority (improve ergonomics)

- `src/core/http/HttpClient.ts` - Error handling tested, retry logic well covered
- `src/core/BaseClient.ts` - Could be simplified
- `src/core/config/EnvLoader.ts` - Too complex
- ✅ `src/clients/ledger-json-api/operations/` - JSDoc comments now auto-generated
- ✅ `scripts/generate-all-client-methods.ts` - Now generates JSDoc comments

## Notes / Decisions Made

(Log changes from original plan as implementation proceeds)

---

## Backlog / Future Work

### Consolidate Operation Patterns

**Status**: ✅ Completed (2026-01-12)

**Context**: The codebase uses a mix of class-based and factory-based operations. The factory
pattern (`createApiOperation`) is newer and preferred for REST operations.

**Current state:**

- Factory pattern: Most operations in `ledger-json-api/operations/v2/`
- Class pattern: `SubscribeToUpdates`, `GetActiveContracts` (WebSocket/streaming),
  `GetMemberTrafficStatus` (async defaults)

**Completed**:

- [x] Document when to use each pattern (factory for REST, class for complex operations)
- [x] Update `CONTRIBUTING.md` with operation pattern guidelines
- [x] Update `llms.txt` with corrected operation pattern documentation

**Decision**: Class-based REST operations (`GetMemberTrafficStatus`, `GetParties`, `ListParties`)
are intentionally kept as classes because they require async pre-processing (fetching defaults,
pagination). The factory pattern cannot easily support async logic before making the request.

### Request/Response Debug Logging

**Status**: ✅ Completed (2026-01-07)

**Context**: While `HttpClient` already logs requests/responses, there was no easy way to enable
debug logging at the client level.

**Completed**:

- [x] Add `debug` option to `ClientConfig` for verbose logging
- [x] Add log level configuration (error, warn, info, debug)
- [x] Create `ConsoleLogger` for console output during development
- [x] Create `CompositeLogger` to combine multiple loggers
- [x] Extended `Logger` interface with level methods

### User Onboarding for Wallet Tests

**Priority**: High **Context**: Several integration tests are skipped because they require the user
to be onboarded to the validator. In basic cn-quickstart setup, wallet endpoints return 404 until
onboarding completes.

**Skipped tests**:

- `validator-api/wallet.test.ts` - `getWalletBalance`, `getUserStatus`
- `validator-api/transfers.test.ts` - `listTransferOffers`
- `validator-api/ans.test.ts` - `listAnsEntries`
- `scan-api/balance.test.ts` - `getTotalAmuletBalance`

**TODO**:

- [ ] Add user onboarding step to test setup (call validator's onboard endpoint)
- [ ] Re-enable skipped wallet tests after onboarding is implemented
- [ ] Document onboarding requirements in test README

### Test Data Population on LocalNet

**Priority**: Medium **Context**: Current integration tests only verify that API calls succeed and
return expected types. Many tests (e.g., `listTransferOffers`, `listAnsEntries`) return empty arrays
because no test data exists on LocalNet.

**TODO**:

- [ ] Create test fixtures that populate LocalNet with sample data before tests run
- [ ] Add transfer offer creation in test setup so `listTransferOffers` returns actual offers
- [ ] Add ANS entry creation so `listAnsEntries` returns actual entries
- [ ] Verify response formatting and field values, not just array types
- [ ] Consider using `beforeAll` hooks to create test data once per test suite

**Example improvement for transfers.test.ts**:

```typescript
// Current (basic)
expect(Array.isArray(response.offers)).toBe(true);

// Future (with test data)
expect(response.offers.length).toBeGreaterThan(0);
expect(response.offers[0]).toHaveProperty('contract_id');
expect(response.offers[0]).toHaveProperty('amount');
```

---

## Change Log

### 2026-01-02 — Unit Tests for Utility Functions (PR #XX)

**Added:**

- Unit tests for 15 utility modules with 205 test cases covering:
  - `createParty` — Party creation, funding, pre-approval flows
  - `createTransferOffer` / `acceptTransferOffer` — Transfer offer workflows
  - `transferToPreapproved` — Pre-approved transfer execution
  - `preApproveTransfers` — Transfer pre-approval setup
  - `getAmuletsForTransfer` — Amulet filtering and sorting
  - `getLockedAmuletsForParty` — Locked amulet retrieval
  - `createExternalParty` — External party creation flow
  - `prepareExternalTransaction` / `executeExternalTransaction` — External signing
  - Stellar utilities — Key handling and signing
  - Mining round utilities — Round context and domain ID
  - `findCreatedEventByTemplateId` / `findCreatedEventByTemplateName` — Event lookup
  - `TransactionBatch` — Command batching
  - Fee parser — Fee extraction and validation

**Changed:**

- `src/utils/external-signing/create-external-party.ts`:
  - Removed `userId` field from `CreateExternalPartyResult` (it was always empty and resolved
    automatically by `prepareExternalTransaction`)
  - Added validation to throw error if public key fingerprint cannot be extracted from party ID
- `src/utils/transactions/find-created-event.ts`:
  - Removed unsafe `as unknown as CreatedTreeEvent` cast
  - Defined local `CreatedTreeEventWrapper` interface for proper type safety
  - Used TypeScript's built-in narrowing with `'CreatedTreeEvent' in event` check

### 2026-01-06 — Canton Facade, Examples, and Schema Tests

**Added:**

- High-level `Canton` class (`src/Canton.ts`):
  - Unified entry point for all Canton API clients
  - Shared configuration across ledger, validator, and scan clients
  - Methods: `getNetwork()`, `getProvider()`, `getPartyId()`, `setPartyId()`
- Schema validation tests:
  - `test/unit/schemas/common.test.ts` — 11 tests for TraceContext, Filter, DeduplicationDuration,
    ApiFeatures
  - `test/unit/schemas/commands.test.ts` — 18 tests for CreateCommand, ExerciseCommand,
    DisclosedContract, CommandRequest
- New examples:
  - `examples/canton-quickstart.ts` — Demonstrates Canton unified client
  - `examples/create-party.ts` — Party creation with funding workflow
  - `examples/transfer-amulets.ts` — Transfer offer creation and acceptance
  - `examples/external-signing.ts` — External party signing flow
- Updated `examples/README.md` with documentation for all examples

**Test Coverage:**

- 248 unit tests passing (20 test suites)
- All lint and build checks passing

### 2026-01-07 — Standardized Error Handling and Code Generation Improvements

**Added:**

- `OperationError` class (`src/core/errors.ts`) with structured error codes:
  - `MISSING_CONTRACT` - When required contracts are not found
  - `MISSING_DOMAIN_ID` - When domain ID is missing from contracts
  - `INSUFFICIENT_FUNDS` - When party has no amulets for transfer
  - `INVALID_AMOUNT` - When amount parameter is invalid
  - `INVALID_PARAMETER` - General parameter validation errors
  - `MINING_ROUND_NOT_FOUND` - When no valid mining round exists
  - `PARTY_CREATION_FAILED` - When party creation fails
  - `TRANSACTION_FAILED` - When transaction execution fails
- Error handling tests (`test/unit/core/errors.test.ts`, `test/unit/core/http-client.test.ts`)
- Tests for `getFeaturedAppRightContractDetails` (`test/unit/contracts/featuredAppRight.test.ts`)
- JSDoc comments auto-generated for all client methods via `scripts/generate-all-client-methods.ts`

**Changed:**

- Updated all utility files to use structured errors with context:
  - `src/utils/party/createParty.ts` - Uses `ValidationError`
  - `src/utils/amulet/transfer-to-preapproved.ts` - Uses `OperationError`, `ValidationError`
  - `src/utils/amulet/pre-approve-transfers.ts` - Uses `OperationError`
  - `src/utils/amulet/offers.ts` - Uses `OperationError`
  - `src/utils/amulet/get-locked-amulets.ts` - Uses `ValidationError`
  - `src/utils/amulet/select-funding-amulets.ts` - Uses `ValidationError`
  - `src/utils/mining/mining-rounds.ts` - Uses `OperationError`
  - `src/utils/external-signing/create-external-party.ts` - Uses `OperationError`
  - `src/utils/external-signing/stellar-utils.ts` - Uses `ValidationError`
  - `src/utils/contracts/featuredAppRight.ts` - Uses `OperationError`
  - `src/utils/parsers/fee-parser.ts` - Uses `ValidationError`
  - `src/core/utils/polling.ts` - Uses `OperationError`
- `ValidationError` now accepts optional `context` parameter for debugging info
- `scripts/generate-all-client-methods.ts`:
  - Extracts JSDoc comments from operation files
  - Generates human-readable descriptions for methods without JSDoc
  - All generated client methods now have JSDoc documentation

**Test Coverage:**

- 284 unit tests passing (23 test suites)
- All lint and build checks passing

### 2026-01-07 — Request/Response Debug Logging

**Added:**

- `ConsoleLogger` class (`src/core/logging/ConsoleLogger.ts`):
  - Logs to console with colors and formatting
  - Supports log levels (error, warn, info, debug)
  - Sanitizes sensitive data (passwords, tokens)
  - Truncates long responses for readability
- `CompositeLogger` class (`src/core/logging/CompositeLogger.ts`):
  - Delegates log calls to multiple loggers
  - Enables simultaneous file and console logging
- Extended `Logger` interface with log level methods:
  - `debug()`, `info()`, `warn()`, `error()` methods
  - `LogLevel` type and `LOG_LEVEL_VALUES` priority constants
- `debug` option in `ClientConfig` and `CantonConfig`:
  - When true, enables verbose console logging
  - Can also be enabled via `CANTON_DEBUG=1` environment variable
  - Automatically creates CompositeLogger with FileLogger + ConsoleLogger
- Unit tests for logging (`test/unit/core/logging.test.ts`):
  - 22 tests for ConsoleLogger, CompositeLogger, FileLogger
  - Tests for log level filtering, sanitization, delegation

**Changed:**

- `src/core/logging/Logger.ts`:
  - Added `LogLevel` type and `LOG_LEVEL_VALUES` constant
  - Extended `Logger` interface with optional level methods
  - Added `logLevel` to `LoggerConfig`
- `src/core/logging/FileLogger.ts`:
  - Implements new log level methods
  - Respects log level configuration
- `src/core/BaseClient.ts`:
  - Auto-creates ConsoleLogger when debug mode is enabled
  - Checks `CANTON_DEBUG` environment variable
- `src/clients/scan-api/ScanApiClient.ts`:
  - Passes `debug` option to base client
- `src/Canton.ts`:
  - Added `debug` option to `CantonConfig`
  - Passes debug option to all clients

**Test Coverage:**

- 306 unit tests passing (24 test suites)
- All lint and build checks passing

### 2026-01-12 — Consolidated Operation Patterns Documentation

**Added:**

- Comprehensive operation pattern guidelines in `CONTRIBUTING.md`:
  - When to use factory pattern (`createApiOperation`, `createWebSocketOperation`)
  - When to use class pattern (async pre-processing, complex WebSocket lifecycle)
  - Decision guide table for pattern selection
  - Code examples for each pattern
- Updated `llms.txt` with corrected operation pattern information

**Changed:**

- `CONTRIBUTING.md`: Added "Operation Patterns" section with detailed documentation
- `llms.txt`: Updated "Operation Pattern" section to show factory pattern as preferred

---

_Last updated: 2026-01-12_
