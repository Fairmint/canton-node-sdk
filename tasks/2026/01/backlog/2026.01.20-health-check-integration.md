# Task: Health Check Integration

**Date**: 2026-01-20  
**Author**: Backlog  
**Status**: Open  
**Priority**: Low  
**Source**: [Canton Network TL;DR Documentation](https://docs.digitalasset.com/build/3.4/overview/tldr.html)

## Goal

Add utilities for checking Canton Network service health and readiness, enabling SDK consumers to
implement proper health-aware service patterns.

## Context

The Canton Network provides health check endpoints for validator nodes:

```bash
# Validator health endpoints
curl -f http://localhost:2903/api/validator/readyz  # App User
curl -f http://localhost:3903/api/validator/readyz  # App Provider
```

### Current SDK State

The SDK already provides health checks for Scan API:

```typescript
// Existing Scan API health operations
await canton.scan.isReady();      // GET /readyz
await canton.scan.isLive();       // GET /livez
await canton.scan.getHealthStatus(); // GET /status
await canton.scan.getVersion();   // GET /version
```

The SDK also has a polling utility that could be leveraged:

```typescript
// src/core/utils/polling.ts
await waitForCondition(check, { timeout: 30000, interval: 1000 });
```

### What's Missing

- Health check operations for Validator API
- Unified health check across all services
- Wait-for-ready utility that wraps `waitForCondition` with Canton-specific semantics

## Scope

### In Scope

- [ ] Add Validator API health check operations (`isReady`, `isLive`)
- [ ] Add unified `checkHealth()` method to `Canton` class
- [ ] Add `waitForReady()` utility leveraging existing polling
- [ ] Add Ledger JSON API version/health if endpoints exist
- [ ] Document health check usage patterns

### Out of Scope (Future Work)

- Circuit breaker patterns (add if needed later)
- Connection state management / reconnection logic
- Health check caching with TTL
- Periodic background health monitoring

## Implementation Plan

### Phase 1: Validator API Health Operations

Add health check operations to ValidatorApiClient:

```typescript
// src/clients/validator-api/operations/v0/health.ts
export const IsReady = createApiOperation<void, void>({
  paramsSchema: z.void(),
  method: 'GET',
  buildUrl: (_params, apiUrl) => `${apiUrl}/api/validator/readyz`,
  requestConfig: { includeBearerToken: false },
});

export const IsLive = createApiOperation<void, void>({
  paramsSchema: z.void(),
  method: 'GET',
  buildUrl: (_params, apiUrl) => `${apiUrl}/api/validator/livez`,
  requestConfig: { includeBearerToken: false },
});
```

Files to create/modify:

- `src/clients/validator-api/operations/v0/health.ts` (new)
- `src/clients/validator-api/ValidatorApiClient.ts` (add methods)

### Phase 2: Unified Health Check

Add health check method to `Canton` class:

```typescript
export interface ServiceHealthStatus {
  scan: { ready: boolean; latencyMs?: number };
  validator: { ready: boolean; latencyMs?: number };
  ledger: { ready: boolean; latencyMs?: number };
}

export interface HealthCheckOptions {
  /** Timeout for each service check in ms (default: 5000) */
  timeoutMs?: number;
  /** Check all services in parallel (default: true) */
  parallel?: boolean;
}

// In Canton class
async checkHealth(options?: HealthCheckOptions): Promise<ServiceHealthStatus>;
```

Files to modify:

- `src/Canton.ts`

### Phase 3: Wait-for-Ready Utility

Add a Canton-specific wait-for-ready that wraps `waitForCondition`:

```typescript
// src/utils/health/wait-for-ready.ts
export interface WaitForReadyOptions {
  /** Maximum wait time in ms (default: 300000 = 5 min) */
  maxWaitMs?: number;
  /** Interval between checks in ms (default: 5000) */
  checkIntervalMs?: number;
  /** Which services to wait for (default: all) */
  services?: ('scan' | 'validator' | 'ledger')[];
  /** Callback for progress updates */
  onProgress?: (attempt: number, status: ServiceHealthStatus) => void;
}

export async function waitForReady(
  canton: Canton,
  options?: WaitForReadyOptions
): Promise<ServiceHealthStatus>;
```

Files to create:

- `src/utils/health/wait-for-ready.ts`
- `src/utils/health/index.ts`

### Phase 4: Canton Class Integration (Optional)

Add convenience option to Canton constructor:

```typescript
// Usage
const canton = await Canton.create({
  network: 'localnet',
  waitForReady: true, // Auto-wait for services on init
});
```

This is optional and can be deferred if `waitForReady()` as a standalone function is sufficient.

## Testing Requirements

- [ ] Unit tests for health check parsing/error handling
- [ ] Unit tests for `waitForReady` timeout behavior
- [ ] Integration tests with LocalNet health endpoints
- [ ] Test for partial service availability (scan up, validator down)

## Acceptance Criteria

- [ ] Validator API client has `isReady()` and `isLive()` methods
- [ ] Canton class has `checkHealth()` method
- [ ] `waitForReady()` utility blocks until services are available
- [ ] Health check timeout is configurable
- [ ] Documentation explains health check usage patterns

## Related Documentation

- [CN Quickstart Project Structure - Health Checks](https://docs.digitalasset.com/build/3.4/quickstart/configure/project-structure-overview.html#health-checks)
- [CN Quickstart FAQ](https://docs.digitalasset.com/build/3.4/quickstart/troubleshoot/cnqs-faq.html)

## Notes

- LocalNet can take 4-5 minutes to become healthy - document this
- Health checks should be non-blocking by default
- The Scan API health operations already exist and can serve as reference
- Consider adding a "Quick Start" example showing health check before operations
